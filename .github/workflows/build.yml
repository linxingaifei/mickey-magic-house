name: OpenWrt x86_64 ISP Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
  # 可选：每天凌晨自动构建
  schedule:
    - cron: "0 3 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    # 1. Checkout 代码
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. 安装依赖
    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev \
          libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

    # 3. 清理磁盘空间（免费 Runner）
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo docker image prune -a -f || true

    # 4. 下载 OpenWrt 源码
    - name: Clone OpenWrt
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt || true
        cd openwrt
        git fetch --tags
        git checkout openwrt-23.05
        git reset --hard origin/openwrt-23.05

    # 5. 复制你的精简 .config
    - name: Copy .config
      run: |
        cp configs/x86_64_isp_config openwrt/.config

    # 6. 更新 feeds
    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 7. Defconfig
    - name: Run defconfig
      run: |
        cd openwrt
        make defconfig

    # 8. 下载依赖包
    - name: Download Packages
      run: |
        cd openwrt
        make download -j2

    # 9. 编译固件
    - name: Build OpenWrt
      run: |
        cd openwrt
        make -j2 V=s

    # 10. 上传固件为 artifact
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86_64-isp
        path: openwrt/bin/targets/x86/64/
