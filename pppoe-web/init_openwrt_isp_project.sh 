#!/bin/bash

PROJECT_DIR="/root/pppoe_web"

echo "ðŸš€ åˆ›å»ºé¡¹ç›®ç›®å½•..."

mkdir -p $PROJECT_DIR/web_backend
mkdir -p $PROJECT_DIR/web_frontend
mkdir -p $PROJECT_DIR/logs
mkdir -p $PROJECT_DIR/backups

echo "ðŸ“¦ åˆ›å»º Flask åŽç«¯ app.py..."

cat > $PROJECT_DIR/web_backend/app.py << 'EOF'
from flask import Flask, jsonify
import sqlite3
import os

app = Flask(__name__)
DB_PATH = "pppoe.db"

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("""
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE,
        password TEXT,
        group_name TEXT,
        rate_limit TEXT,
        note TEXT
    )
    """)
    conn.commit()
    conn.close()

@app.route("/")
def index():
    return jsonify({"status": "OpenWrt ISP Web Backend Running"})

@app.route("/users")
def list_users():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT * FROM users")
    rows = c.fetchall()
    conn.close()
    return jsonify(rows)

if __name__ == "__main__":
    init_db()
    app.run(host="0.0.0.0", port=5000)
EOF

echo "ðŸ³ åˆ›å»º Dockerfile..."

cat > $PROJECT_DIR/web_backend/Dockerfile << 'EOF'
FROM python:3.10-alpine

WORKDIR /app
COPY app.py /app

RUN pip install flask

EXPOSE 5000

CMD ["python", "app.py"]
EOF

echo "ðŸ“„ åˆ›å»º docker-compose.yml..."

cat > $PROJECT_DIR/docker-compose.yml << 'EOF'
version: "3"
services:
  pppoe_web:
    build: ./web_backend
    container_name: pppoe_web
    ports:
      - "5000:5000"
    volumes:
      - ./web_backend:/app
      - /etc/ppp/chap-secrets:/chap-secrets
    restart: always
EOF

echo "ðŸ’¾ åˆ›å»ºæ•°æ®åº“å¤‡ä»½è„šæœ¬..."

cat > $PROJECT_DIR/backup_db.sh << 'EOF'
#!/bin/bash
cp /root/pppoe_web/web_backend/pppoe.db \
/root/pppoe_web/backups/pppoe_$(date +%F_%T).db
EOF

chmod +x $PROJECT_DIR/backup_db.sh

echo "ðŸš€ åˆ›å»ºä¸€é”®éƒ¨ç½²è„šæœ¬..."

cat > $PROJECT_DIR/deploy_pppoe_web.sh << 'EOF'
#!/bin/bash
cd /root/pppoe_web
docker-compose down
docker-compose build
docker-compose up -d
echo "âœ… éƒ¨ç½²å®Œæˆ"
EOF

chmod +x $PROJECT_DIR/deploy_pppoe_web.sh

echo "ðŸ“˜ åˆ›å»º README.md..."

cat > $PROJECT_DIR/README.md << 'EOF'
# OpenWrt x86 ISP PPPoE Web System

## å¯åŠ¨
bash deploy_pppoe_web.sh

è®¿é—®ï¼š
http://OpenWrt-IP:5000
EOF

echo "ðŸŽ‰ é¡¹ç›®ç”Ÿæˆå®Œæˆï¼"
echo "ç›®å½•ï¼š$PROJECT_DIR"
